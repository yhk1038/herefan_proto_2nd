<section id="library" class="container contents_box">
    <div class="row" id="libraries_wrapper">
        <% @links.order(id: :desc).each do |link| %>
            <%
                user = link.user
                user ||= User.first
                current_user_id = $current_user_id

                myclips = Clip.where(link: link, user_id: current_user_id)
                myclips_already = myclips.count.zero? ? false : true

                mylikes = Like.where(link: link, user_id: current_user_id)
                mylikes_already = mylikes.count.zero? ? false : true

                myvisites = VisitedLink.where(link: link, user_id: current_user_id)
                myvisites_already = myvisites.count.zero? ? false : true

                visited_count = link.visited_links.pluck(:viewcount).inject(:+)
            %>
            <!--col-md-4 col-sm-3 col-xs-6-->
            <div class="task">
                <div id="link_<%= link.id %>" noiser="<%= current_user_id %>" class="card blog-post link_wrapping_anchor no-mute <%= 'usi' if user_signed_in? %> <%= 'clipped' if myclips_already %> <%= 'visited' if myvisites_already %> <%= link.typee && link.typee >= 1 && link.typee <= 3 ? "type-#{link.typee}" : '' %>">
                    <div class="bp-header">
                        <a href="<%= link.url %>" target="_blank">
                            <a class="clip_btn" action_status="<%= myclips_already ? 'delete' : 'post' %>" action_target="<%= myclips_already ? myclips.take.id : link.id %>" action_noiser="<%= current_user_id %>">
                                <span id="cliped_<%= link.id %>" class="clip zmdi zmdi-bookmark-outline"></span>
                            </a>
                            <a href="<%= link.url %>" target="_blank">
                                <img class="link_main_image" src="<%= link.image %>" height="171" alt="">
                            </a>
                            <a href="<%= link.url %>" target="_blank">
                                <div class="user_profile">
                                    <div class="lv-item">
                                        <div class="media">
                                            <div class="pull-left">
                                                <div class="lv-img-sm bg_img_cover" style="background: url('<%= user.img.nil? ? image_with_sns(user.image.to_s) : user.img %>');" data-pin-nopin="true"></div>
                                            </div>
                                            <div class="media-body">
                                                <div class="lv-title"><%= user.nickname %></div>
                                                <small class="lv-small"><%= distance_of_time_in_words(link.created_at.to_time, Time.now) %> before</small>
                                            </div>
                                            <ul id="actions_<%= link.id %>" class="actions_box">
                                                <a class="action maum" action_status="<%= mylikes_already ? 'delete' : 'post' %>" action_target="<%= mylikes_already ? mylikes.take.id : link.id %>" action_noiser="<%= current_user_id %>">
                                                    <span class="zmdi zmdi-favorite<%= '-outline' unless mylikes_already %>"></span> <span class="counter"><%= link.likes.count %></span>
                                                </a>
                                                <a class="action viewcount" href="<%= link.url %>" target="_blank">
                                                    <span class="zmdi zmdi-eye"></span> <span class="counter"><%= visited_count ? visited_count : 0 %></span>
                                                </a>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            <ul class="actions actions-alt moreBtn">
                                <li class="dropdown">
                                    <a href="" data-toggle="dropdown" aria-expanded="false"><i class="zmdi zmdi-more-vert"></i></a>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <% if link.user == current_user %>
                                            <li><%= link_to 'edit', edit_link_path(link) %></li>
                                            <li><%= button_to 'Destroy', link, method: :delete, onclick: "return confirm('Are you sure you want to delete this link?')", class: 'likes_link_to' %></li>
                                        <% else %>
                                            <li><%= link_to 'report', '#' %></li>
                                        <% end %>
                                    </ul>
                                </li>
                            </ul>
                        </a>
                        <a href="<%= link.url %>" target="_blank" class="bp-title">
                            <h2 class="linkcard-title"><%== link.title %></h2>
                            <small class="linkcard-description"><%== link.description %></small>
                        </a>
                        <div class="dropdown share_box">
                            <a data-toggle="dropdown" aria-expanded="false" class="btn bgm-green btn-float waves-effect no-vl" style="right: 20px; bottom: -23px;"><i class="zmdi zmdi-share"></i></a>
                            <ul class="dropdown-menu pull-right no-vl go-social">
                                <li role="presentation" class="dropdown-header">share this contents!</li>
                                <li class="sns_share card-body clearfix">
                                    <a class="col-xs-4" href="http://www.facebook.com/sharer/sharer.php?u=<%= link.url %>" onclick="window.open(this.href); return false"><img src="/template/img/social/facebook-128.png" class="img-responsive" alt=""></a>
                                    <a class="col-xs-4" href="https://twitter.com/intent/tweet?text=<%= link.message.gsub(' ','_') %>&url=<%= link.url %>" onclick="window.open(this.href); return false"><img src="/template/img/social/twitter-128.png" class="img-responsive" alt=""></a>
                                    <a class="col-xs-4" href="https://plus.google.com/share?url=<%= link.url %>" onclick="window.open(this.href); return false"><img src="/template/img/social/googleplus-128.png" class="img-responsive" alt=""></a>
                                </li>
                                <li class="divider"></li>
                                <li class="clipboarding">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="zmdi zmdi-globe"></i></span>
                                        <div id="text_url_<%= link.id %>" type="text" class="form-control fc-alt" aria-label="Amount (to the nearest dollar)"><%= link.url %></div>
                                        <span target="<%= link.id %>" data-clipboard-target="#text_url_<%= link.id %>" class="input-group-addon url_copy"><i class="zmdi zmdi-copy"></i></span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <a href="<%= link.url %>" target="_blank">
                        <div class="p-20">
                            <p class="msg"><%= link.message %></p>
                            <p class="url m-b-0"><%= link.url %></p>
                        </div>
                    </a>
                </div>
            </div>
        <% end %>
    </div>
</section>